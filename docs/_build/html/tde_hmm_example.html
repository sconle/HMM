<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Univariate TDE-HMM &mdash; neuroHMM  documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="TDE-HMM for wide-range burst detection" href="tde_hmm_example_our_data.html" />
    <link rel="prev" title="Examples" href="example.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> neuroHMM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="theory.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_reference.html">API Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="example.html">Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Univariate TDE-HMM</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Libraries,-Functions,-Storage">Libraries, Functions, Storage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Libraries-and-functions">Libraries and functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Storage">Storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Other-useful-functions">Other useful functions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Parameters">Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Script">Script</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Inferring-the-HMM-on-all-subjects-of-subj_list-concatenated-together">Inferring the HMM on all subjects of <code class="docutils literal notranslate"><span class="pre">subj_list</span></code> concatenated together</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Inferring-the-HMM-on-each-subject-of-subj_list-one-after-the-other">Inferring the HMM on each subject of <code class="docutils literal notranslate"><span class="pre">subj_list</span></code> one after the other</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Plotting-the-fractional-occupancies-of-the-states,-the-averaged-wavelet-transform-and-rhe-states-PSD-on-one-big-figure-for-each-subject,-each-IC">Plotting the fractional occupancies of the states, the averaged wavelet-transform and rhe states PSD on one big figure for each subject, each IC</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Plotting-the-time-course-of-each-states-for-n_trials_to_plot-trials-on-a-figure-for-each-subject,-each-IC">Plotting the time-course of each states for <code class="docutils literal notranslate"><span class="pre">n_trials_to_plot</span></code> trials on a figure for each subject, each IC</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tde_hmm_example_our_data.html">TDE-HMM for wide-range burst detection</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">neuroHMM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="example.html">Examples</a> &raquo;</li>
      <li>Univariate TDE-HMM</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tde_hmm_example.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Univariate-TDE-HMM">
<h1>Univariate TDE-HMM<a class="headerlink" href="#Univariate-TDE-HMM" title="Permalink to this headline"></a></h1>
<p>In this notebook, we apply a TDE-HMM on the time course of a single independent component (IC). The notebook is separated in three distinct parts: - In the first part, we import or define the libraries and methods that will be usefull to execute the code. We also define the location of the where to find and store our data. - In the second part, we specify the metaparameters and options we want for the execution of the code. - In the third part, we run the TDE-HMM on our raw data with specified
parameters, then store it in netCDF files. Finally, we can decide to plot some interesting results on figures.</p>
<section id="Libraries,-Functions,-Storage">
<h2>Libraries, Functions, Storage<a class="headerlink" href="#Libraries,-Functions,-Storage" title="Permalink to this headline"></a></h2>
<section id="Libraries-and-functions">
<h3>Libraries and functions<a class="headerlink" href="#Libraries-and-functions" title="Permalink to this headline"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Storage management</span>
<span class="kn">import</span> <span class="nn">pickle</span>   <span class="c1"># The inferred model parameters are stored in a .pkl file</span>
<span class="kn">import</span> <span class="nn">h5py</span>   <span class="c1"># Manages .mat files in Python</span>
<span class="kn">from</span> <span class="nn">loader</span> <span class="kn">import</span> <span class="n">load_oneIC</span>  <span class="c1"># Stores temporarily useful data from our .mat data file in a dictionary</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>   <span class="c1"># Manages .nc (netCDF) files in Python.</span>
                      <span class="c1"># The states&#39; informations are stored in a .nc file for each subject.</span>

<span class="c1"># Scientific computing</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">scale</span>
<span class="kn">from</span> <span class="nn">hmmlearn</span> <span class="kn">import</span> <span class="n">hmm</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">from</span> <span class="nn">wavelet_transform</span> <span class="kn">import</span> <span class="n">wavelet_transform</span>

<span class="c1"># Else</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">tm</span>
</pre></div>
</div>
</div>
</section>
<section id="Storage">
<h3>Storage<a class="headerlink" href="#Storage" title="Permalink to this headline"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">FCK_LOCKED_IC_JYOTIKA_250819.mat</span></code> contains 23x4 Matlab structures containing the data for each of the 23 subjects and each IC when they exist. The existing ICs can be visualised in the <code class="docutils literal notranslate"><span class="pre">data_structure.png</span></code> screen capture, or using Matlab. Each of these structures, when they exist, contain the fields we can visualise in the <code class="docutils literal notranslate"><span class="pre">data_labels.png</span></code> screen capture or using Matlab.</p>
<p>The way we access these data with Python can be understood by reading the loader.py script.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Storage management</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>   <span class="c1"># Manages .nc (netCDF) files in Python.</span>
                      <span class="c1"># The states&#39; informations are stored in a .nc file for each subject.</span>

<span class="c1"># Scientific computing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">myHmmPackage.cluster_decoding</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">myHmmPackage.cluster_decoder</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">data_dir</span></code> and <code class="docutils literal notranslate"><span class="pre">figures_dir</span></code> are the directories in which you will store and search for the data and the figures the algorithm produces.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">figures_dir</span> <span class="o">=</span> <span class="s2">&quot;../data/figures/&quot;</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s2">&quot;../data/model_data/&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="Other-useful-functions">
<h3>Other useful functions<a class="headerlink" href="#Other-useful-functions" title="Permalink to this headline"></a></h3>
<p>The embedx function copies the <code class="docutils literal notranslate"><span class="pre">x</span></code> array len(lags) times into <code class="docutils literal notranslate"><span class="pre">xe</span></code> with lags (i.e. time delays) between <code class="docutils literal notranslate"><span class="pre">lags[0]</span></code> and <code class="docutils literal notranslate"><span class="pre">lags[-1]</span></code> (we implement the time-delay array for the HMM).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">statesPSD</span></code> function returns the Power Spectral Density (PSD) characterising each state of the inferred HMM using the Welch method on the bits of raw time-courses in which the state is ‘on’ (probability of presence &gt; 2/3). It is a non-parametric method since we don’t use the inferred parameters of the HMM to compute this PSD. The frequency axis corresponding with the computed PSD is also returned with <code class="docutils literal notranslate"><span class="pre">freqs</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">statesPSD</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">n_states</span><span class="p">,</span> <span class="n">xe</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">256</span><span class="o">/</span><span class="mi">3</span><span class="p">):</span>

    <span class="n">psd_all</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_states</span><span class="p">):</span>

        <span class="c1"># Compute PSD separately for each lag</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">xe</span><span class="p">[</span><span class="n">gamma</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">),</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
            <span class="n">freqs</span><span class="p">,</span> <span class="n">psd</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">seg</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">nfft</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">tot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span>
        <span class="n">psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tot</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">psd_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span>

    <span class="n">psd_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">psd_all</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">psd_all</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Parameters">
<h2>Parameters<a class="headerlink" href="#Parameters" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Imput data parameters</span>
<span class="c1"># subj_list = [2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 14, 16, 17, 18, 19, 20, 21, 22, 23] # All except 1, 9, 13, 15</span>
<span class="c1"># subj_list = [2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 14, 16, 17, 18, 19, 22, 23] # same &amp;&amp; IC1 exists</span>
<span class="n">subj_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="c1"># IC_list = [1, 2, 3, 4]</span>
<span class="n">IC_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">downsamp_rate</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># The downsampling rate of the raw time-courses</span>
<span class="c1"># downsamp_rate = 1</span>
<span class="c1">## start_idx and end_idx are the indexes of the trial time-courses on which you want to start and end the HMM.</span>
<span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Corresponds to the beginning of the trials, i.e. -4s.</span>
<span class="c1"># start_idx = 4*256  # Corresponds to the time-locking (i.e.0s)</span>
<span class="n">end_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Corresponds to the end of the trial (i.e. 3s)</span>
<span class="c1"># end_idx = 4*256  # Corresponds to the time-locking (i.e.0s)</span>
<span class="n">lags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># The time-delay embedding</span>
<span class="c1"># lags = np.arange(-29, 29)</span>
<span class="c1"># lags = np.arange(-11, 12)</span>
<span class="n">n_lags</span> <span class="o">=</span> <span class="n">lags</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">apply_PCA</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Do we apply a PCA before inferring the HMM?</span>
<span class="n">n_components</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># Number of principal components in case of PCA</span>
<span class="c1"># n_components = 40</span>

<span class="c1">### HMM parameters</span>
<span class="n">all_subj_first</span> <span class="o">=</span> <span class="kc">False</span>   <span class="c1"># Do we compute the model on all subjects before refining it for each subject?</span>
<span class="n">covariance_type</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>
<span class="c1"># covariance_type = &#39;diag&#39;  # ONLY IN CASE OF PCA</span>
<span class="n">n_iter</span> <span class="o">=</span> <span class="mi">1000000</span>  <span class="c1"># The maximum number of iterations of the EM algorithm if we don&#39;t meet the next requirement.</span>
<span class="n">tol</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># The EM algorithm will stop if the maximum likelihood of the HMM</span>
            <span class="c1"># varies under this tolerence for each iteration.</span>

<span class="c1">### Output data parameters</span>
<span class="c1"># n_states_list = [3, 4, 5, 6]    # Number of hidden Markov states. Must be a list.</span>
<span class="n">n_states_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="Script">
<h2>Script<a class="headerlink" href="#Script" title="Permalink to this headline"></a></h2>
<section id="Inferring-the-HMM-on-all-subjects-of-subj_list-concatenated-together">
<h3>Inferring the HMM on all subjects of <code class="docutils literal notranslate"><span class="pre">subj_list</span></code> concatenated together<a class="headerlink" href="#Inferring-the-HMM-on-all-subjects-of-subj_list-concatenated-together" title="Permalink to this headline"></a></h3>
</section>
<section id="Inferring-the-HMM-on-each-subject-of-subj_list-one-after-the-other">
<h3>Inferring the HMM on each subject of <code class="docutils literal notranslate"><span class="pre">subj_list</span></code> one after the other<a class="headerlink" href="#Inferring-the-HMM-on-each-subject-of-subj_list-one-after-the-other" title="Permalink to this headline"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">complete_time</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">n_states</span> <span class="ow">in</span> <span class="n">n_states_list</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;****** </span><span class="si">{</span><span class="n">n_states</span><span class="si">}</span><span class="s2"> STATES ******&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subj_list</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ** SUBJECT</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2"> **    &quot;</span><span class="p">)</span>
        <span class="n">tcourses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">psds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">IC_new_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">IC</span> <span class="ow">in</span> <span class="n">IC_list</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;---- SUBJECT</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2">, IC</span><span class="si">{</span><span class="n">IC</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">n_states</span><span class="si">}</span><span class="s2"> states ----&quot;</span><span class="p">)</span>
                <span class="c1"># Loading all data for subject{subj}, IC{IC}</span>
                <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span> <span class="o">+</span> <span class="s2">&quot;/../../&quot;</span><span class="p">)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">dirname</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/data/su</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2">IC</span><span class="si">{</span><span class="n">IC</span><span class="si">}</span><span class="s2">_rawdata.nc&quot;</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;timecourse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing and saving the model&quot;</span><span class="p">)</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">TDE_HMM</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">n_states</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span>
                                <span class="n">covariance_type</span><span class="o">=</span><span class="n">covariance_type</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span> <span class="c1"># MODIFY PARAMETERS</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ok1&quot;</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ok2&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;su</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2">IC</span><span class="si">{</span><span class="n">IC</span><span class="si">}</span><span class="s2">_st</span><span class="si">{</span><span class="n">n_states</span><span class="si">}</span><span class="s2">_lg</span><span class="si">{</span><span class="n">n_lags</span><span class="si">}</span><span class="s2">co</span><span class="si">{</span><span class="n">n_components</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;UnivariateGaussianHMM.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing the Probability time-course and the Power Spectral Density of each state&quot;</span><span class="p">)</span>
                <span class="n">gamma</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ok3&quot;</span><span class="p">)</span>
                <span class="n">tcourse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">lags</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">n_states</span><span class="p">)),</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">n_states</span><span class="p">)))</span>
                <span class="p">)</span>
                <span class="n">t_len</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time_axis&quot;</span><span class="p">][</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">:</span><span class="n">downsamp_rate</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tcourse_trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_trials</span><span class="p">,</span> <span class="n">t_len</span><span class="p">,</span> <span class="n">n_states</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">):</span>
                    <span class="n">tcourse_trials</span><span class="p">[</span><span class="n">tr</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcourse</span><span class="p">[</span><span class="n">tr</span><span class="o">*</span><span class="n">t_len</span><span class="p">:(</span><span class="n">tr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">t_len</span><span class="p">]</span>
                <span class="n">tcourses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tcourse_trials</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
                <span class="n">freqs</span><span class="p">,</span> <span class="n">psd</span> <span class="o">=</span> <span class="n">statesPSD</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">n_states</span><span class="p">,</span> <span class="n">xe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fs</span><span class="o">=</span><span class="mi">256</span><span class="o">/</span><span class="n">downsamp_rate</span><span class="p">)</span>
                <span class="n">psd</span> <span class="o">=</span> <span class="n">psd</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,]</span>
                <span class="n">psds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span>
                <span class="n">IC_new_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IC</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model for subj</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2">, IC</span><span class="si">{</span><span class="n">IC</span><span class="si">}</span><span class="s2"> computed: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">tm</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The model for subj</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2">, IC</span><span class="si">{</span><span class="n">IC</span><span class="si">}</span><span class="s2"> was NOT computed&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving the data for subj</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2">: Proba. time-course, Frac. occupancy and PSD&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tcourses</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">tcourses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tcourses</span><span class="p">))</span>
            <span class="n">psds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">psds</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tcourses</span> <span class="o">=</span> <span class="n">tcourses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">psds</span> <span class="o">=</span> <span class="n">psds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;states_timecourse&quot;</span><span class="p">:</span> <span class="p">((</span><span class="s2">&quot;IC&quot;</span><span class="p">,</span> <span class="s2">&quot;trials&quot;</span><span class="p">,</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;states&quot;</span><span class="p">),</span> <span class="n">tcourses</span><span class="p">),</span>
                <span class="s2">&quot;states_psd&quot;</span><span class="p">:</span> <span class="p">((</span><span class="s2">&quot;IC&quot;</span><span class="p">,</span> <span class="s2">&quot;states&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">),</span> <span class="n">psds</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;IC&quot;</span><span class="p">:</span><span class="n">IC_new_list</span><span class="p">,</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;time_axis&quot;</span><span class="p">][</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">:</span><span class="n">downsamp_rate</span><span class="p">],</span>
                <span class="s2">&quot;states&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_states</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="n">freqs</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">frac_occ</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;states_timecourse&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;trials&quot;</span><span class="p">)</span><span class="o">/</span><span class="n">ds</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;trials&quot;</span><span class="p">]))</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;su</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2">_st</span><span class="si">{</span><span class="n">n_states</span><span class="si">}</span><span class="s2">_lg</span><span class="si">{</span><span class="n">n_lags</span><span class="si">}</span><span class="s2">co</span><span class="si">{</span><span class="n">n_components</span><span class="si">}</span><span class="s2">_data.nc&quot;</span><span class="p">)</span>


<span class="n">sec_time</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">complete_time</span>
<span class="n">hr_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec_time</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span>
<span class="n">sec_time</span> <span class="o">=</span> <span class="n">sec_time</span> <span class="o">-</span> <span class="p">(</span><span class="n">hr_time</span><span class="o">*</span><span class="mi">3600</span><span class="p">)</span>
<span class="n">mn_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec_time</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
<span class="n">sec_time</span> <span class="o">=</span> <span class="n">sec_time</span> <span class="o">-</span> <span class="p">(</span><span class="n">mn_time</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run time: </span><span class="si">{</span><span class="n">hr_time</span><span class="si">}</span><span class="s2">h</span><span class="si">{</span><span class="n">mn_time</span><span class="si">}</span><span class="s2">mn</span><span class="si">{</span><span class="n">sec_time</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
****** 3 STATES ******
    ** SUBJECT2 **
---- SUBJECT2, IC1 - 3 states ----
Loading the raw timecourse
Computing and saving the model
ok1
ok2
ok3
ok4
ok5
ok6
Computing the Probability time-course and the Power Spectral Density of each state
Model for subj2, IC1 computed: 76 seconds
Saving the data for subj2: Proba. time-course, Frac. occupancy and PSD
Run time: 0h1mn16.18023371696472s
</pre></div></div>
</div>
</section>
<section id="Plotting-the-fractional-occupancies-of-the-states,-the-averaged-wavelet-transform-and-rhe-states-PSD-on-one-big-figure-for-each-subject,-each-IC">
<h3>Plotting the fractional occupancies of the states, the averaged wavelet-transform and rhe states PSD on one big figure for each subject, each IC<a class="headerlink" href="#Plotting-the-fractional-occupancies-of-the-states,-the-averaged-wavelet-transform-and-rhe-states-PSD-on-one-big-figure-for-each-subject,-each-IC" title="Permalink to this headline"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">info</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">create_info</span><span class="p">(</span><span class="n">ch_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span> <span class="n">sfreq</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">ch_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;eeg&#39;</span><span class="p">])</span>

<span class="k">for</span> <span class="n">n_states</span> <span class="ow">in</span> <span class="n">n_states_list</span><span class="p">:</span>
    <span class="n">widths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_states</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">gs_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">width_ratios</span><span class="o">=</span><span class="n">widths</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="n">heights</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subj_list</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;su</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2">_st</span><span class="si">{</span><span class="n">n_states</span><span class="si">}</span><span class="s2">_lg</span><span class="si">{</span><span class="n">n_lags</span><span class="si">}</span><span class="s2">co</span><span class="si">{</span><span class="n">n_components</span><span class="si">}</span><span class="s2">_data.nc&quot;</span><span class="p">)</span>
        <span class="n">start_t</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_t</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">IC</span> <span class="ow">in</span> <span class="n">IC_list</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;IC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">IC</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">f_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">widths</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">heights</span><span class="p">)),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                            <span class="n">nrows</span><span class="o">=</span><span class="p">(</span><span class="n">n_states</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">gridspec_kw</span><span class="o">=</span><span class="n">gs_kw</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">f_axes</span><span class="p">[</span><span class="n">state</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;frac_occ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">state</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">state</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;state </span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">ax</span> <span class="o">=</span> <span class="n">f_axes</span><span class="p">[</span><span class="n">n_states</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">n_trials</span> <span class="o">=</span> <span class="n">load_oneIC</span><span class="p">(</span><span class="n">mat_file</span><span class="p">,</span> <span class="n">cells_refs</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">IC</span><span class="p">)</span>
                <span class="n">tfr</span> <span class="o">=</span> <span class="n">wavelet_transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">trial</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_trials</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">mappable</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tfr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
                                       <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">PowerNorm</span><span class="p">(</span><span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlBu_r&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Frequencies IC</span><span class="si">{</span><span class="n">IC</span><span class="si">}</span><span class="s1"> (Hz)&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mappable</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">f_axes</span><span class="p">[</span><span class="n">n_states</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">ax</span> <span class="o">=</span> <span class="n">f_axes</span><span class="p">[</span><span class="n">n_states</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;states_psd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">,]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PSD IC</span><span class="si">{</span><span class="n">IC</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;State </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_states</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">f_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="c1">#                 fig.savefig(figures_dir + f&#39;grid-{n_states}states-subj{subj}-IC{IC}.png&#39;, dpi=300)</span>
<span class="c1">#                 plt.close(fig)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IC</span><span class="si">{</span><span class="n">IC</span><span class="si">}</span><span class="s2"> of subject </span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
<span class="c1">#                 plt.close(fig)</span>
</pre></div>
</div>
</div>
</section>
<section id="Plotting-the-time-course-of-each-states-for-n_trials_to_plot-trials-on-a-figure-for-each-subject,-each-IC">
<h3>Plotting the time-course of each states for <code class="docutils literal notranslate"><span class="pre">n_trials_to_plot</span></code> trials on a figure for each subject, each IC<a class="headerlink" href="#Plotting-the-time-course-of-each-states-for-n_trials_to_plot-trials-on-a-figure-for-each-subject,-each-IC" title="Permalink to this headline"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_trials_to_plot</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">for</span> <span class="n">n_states</span> <span class="ow">in</span> <span class="n">n_states_list</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subj_list</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">f_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="n">n_states</span><span class="o">*</span><span class="n">n_trials_to_plot</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">nrows</span><span class="o">=</span><span class="p">(</span><span class="n">n_states</span><span class="o">*</span><span class="n">n_trials_to_plot</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">IC</span> <span class="ow">in</span> <span class="n">IC_list</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;su</span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2">_st</span><span class="si">{</span><span class="n">n_states</span><span class="si">}</span><span class="s2">_lg</span><span class="si">{</span><span class="n">n_lags</span><span class="si">}</span><span class="s2">co</span><span class="si">{</span><span class="n">n_components</span><span class="si">}</span><span class="s2">_data.nc&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;IC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">IC</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;IC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">==</span><span class="n">IC</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">state</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_trials_to_plot</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">ax</span> <span class="o">=</span> <span class="n">f_axes</span><span class="p">[</span><span class="n">n_trials_to_plot</span><span class="o">*</span><span class="p">(</span><span class="n">state</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">trial</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;states_timecourse&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">trial</span><span class="p">,</span> <span class="p">:,</span> <span class="n">state</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prob. st</span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s2"> tr</span><span class="si">{</span><span class="n">trial</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
                    <span class="c1"># fig.savefig(figures_dir + f&#39;tcourses-{n_states}states-subj{subj}-IC{IC}.png&#39;, dpi=300)</span>
<span class="c1">#                     plt.close(fig)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IC</span><span class="si">{</span><span class="n">IC</span><span class="si">}</span><span class="s2"> of subject </span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="example.html" class="btn btn-neutral float-left" title="Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tde_hmm_example_our_data.html" class="btn btn-neutral float-right" title="TDE-HMM for wide-range burst detection" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Audren Butery, Timothée Fronteau, Solenzio Konlé, Vincent Mousseaux, Valentin Truong Minh Ky.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>